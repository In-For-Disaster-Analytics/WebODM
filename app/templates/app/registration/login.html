{% extends 'registration/registration_base.html' %}
{% load i18n %}
{% load settings %}

{% block registration_content %}
    <div class="text-center">
        <h2>{% trans "Login with Tapis" %}</h2>
        <p class="text-muted">{% trans "This WebODM instance uses Tapis authentication only" %}</p>
        
        {% if form.errors or request.GET.error %}
        <div class="alert alert-warning">
            {% if form.errors %}
                <p><strong>{% trans "Authentication failed." %}</strong></p>
            {% endif %}
            {% if request.GET.error %}
                <p><strong>{% trans "Error:" %}</strong> {{ request.GET.error }}</p>
            {% endif %}
        </div>
        {% endif %}

        {% is_single_user_mode as autologin %}
        
        {% if autologin %}
            <script>location.href='/dashboard/';</script>
        {% else %}
            <div class="login-options" style="margin-top: 30px;">
                <a href="/api/oauth2/tapis/authorize/{{ default_tapis_client_id }}/?redirect_after={% firstof request.GET.next '/dashboard/' %}" 
                   class="btn btn-primary btn-lg" style="padding: 15px 30px; font-size: 16px;">
                    <i class="fa fa-sign-in" style="margin-right: 10px;"></i>
                    {% trans "Login with Tapis" %}
                </a>
            </div>
            
            <div class="help-text" style="margin-top: 30px;">
                <p class="text-muted">
                    {% trans "Need help with Tapis authentication?" %} 
                    <a href="https://tapis.readthedocs.io/en/latest/technical/authentication.html" target="_blank">
                        {% trans "View Tapis documentation" %}
                    </a>
                </p>
            </div>
        {% endif %}
    </div>

    <script>
    $(function() {
        // Show any OAuth2 errors from URL parameters
        var urlParams = new URLSearchParams(window.location.search);
        var error = urlParams.get('oauth_error');
        var errorDesc = urlParams.get('oauth_error_description');
        
        if (error) {
            var errorHtml = '<div class="alert alert-danger" style="margin-top: 20px;">' + 
                           '<strong>OAuth2 Error:</strong> ' + decodeURIComponent(error);
            if (errorDesc) {
                errorHtml += '<br><small>' + decodeURIComponent(errorDesc) + '</small>';
            }
            errorHtml += '</div>';
            $(errorHtml).insertAfter('h2');
        }
    });
    </script>
{% endblock %}